// åœ¨æ²¹çŒ´ä¸­ä½¿ç”¨
// ==UserScript==
// @name         çŸ¥ä¹é¦–é¡µé«˜è´¨é‡é˜…è¯»å™¨
// @namespace    http://tampermonkey.net/
// @version      2.0.0
// @description  åŸºäºæ‘˜è¦é•¿åº¦ã€é…å›¾å’ŒçœŸå®å­—æ•°çš„ä¸‰æ­¥ç²¾å‡†è¿‡æ»¤ï¼Œä¿ç•™å°ç›¾ç‰Œä¼˜é›…æ’ç‰ˆ
// @author       Joy_Su
// @match        https://www.zhihu.com/
// @match        https://www.zhihu.com/follow
// @match        https://www.zhihu.com/hot
// @grant        none
// ==/UserScript==

(function() {
    'use strict';

    // ================= é…ç½®åŒº =================
    const FULLTEXT_MIN_SCORE = 300;  // è§„åˆ™1ï¼šæœªæŠ˜å çš„å®Œæ•´æ–‡ç« ï¼Œç»¼åˆå¾—åˆ†ï¼ˆå­—æ•°+å›¾ç‰‡ï¼‰ä½äºæ­¤å€¼å±è”½
    const IMAGE_WEIGHT = 50;         // 1å¼ å›¾ç‰‡çš„æŠ˜ç®—å­—æ•°æƒé‡

    const SUMMARY_MIN_LENGTH = 60;   // è§„åˆ™3ï¼šè¢«æŠ˜å ä¸”æ— é…å›¾çš„æ–‡ç« ï¼Œæ‘˜è¦å­—æ•°ä½äºæ­¤å€¼å±è”½
    // ==========================================

    /**
     * å¤„ç†å¡ç‰‡çš„ä¸»å‡½æ•°
     */
    function filterShortAnswers() {
        // è·å–æ‰€æœ‰è¿˜æ²¡è¢«æˆ‘ä»¬å¤„ç†è¿‡çš„æ¨èå¡ç‰‡
        const cards = document.querySelectorAll('.Card.TopstoryItem:not([data-processed="true"])');

        cards.forEach(card => {
            // æ‰“ä¸Šæ ‡è®°ï¼Œé¿å…é‡å¤è®¡ç®—
            card.setAttribute('data-processed', 'true');

            // æå–å…³é”®ç‰¹å¾å…ƒç´ 
            const readMoreBtn = card.querySelector('.ContentItem-more');     // å±•å¼€å…¨æ–‡æŒ‰é’®
            const coverImage = card.querySelector('.RichContent-cover');     // å°é¢å›¾
            const richText = card.querySelector('.RichText.ztext');          // æ­£æ–‡/æ‘˜è¦å†…å®¹

            if (!richText) return;

            let shouldBlock = false;
            let blockReason = '';

            // æå–çº¯æ–‡æœ¬å¹¶å‰”é™¤ç©ºæ ¼ï¼Œç”¨äºè®¡ç®—å­—æ•°
            const textContent = richText.textContent || '';
            const pureTextLength = textContent.replace(/\s+/g, '').length;

            // ================= æ ¸å¿ƒä¸‰æ­¥èµ°åˆ¤å†³é€»è¾‘ =================

            if (!readMoreBtn) {
                // ã€æƒ…å†µ 1ï¼šæ²¡æœ‰é˜…è¯»å…¨æ–‡ï¼ˆå…¨æ–‡å·²å®Œå…¨å±•ç¤ºï¼‰ã€‘
                // æ­¤æ—¶ pureTextLength å°±æ˜¯æ–‡ç« çš„çœŸå®æ€»å­—æ•°
                const imageCount = richText.querySelectorAll('figure').length;
                const totalScore = pureTextLength + (imageCount * IMAGE_WEIGHT);

                if (totalScore < FULLTEXT_MIN_SCORE) {
                    shouldBlock = true;
                    blockReason = `å®Œæ•´çŸ­æ–‡ï¼Œç»¼åˆç®—åˆ†: ${totalScore}`;
                }
            } else {
                // ã€æƒ…å†µ 2ï¼šæœ‰é˜…è¯»å…¨æ–‡ï¼ˆé•¿æ–‡è¢«æˆªæ–­ï¼‰ã€‘
                if (coverImage) {
                    // æœ‰é…å›¾ï¼Œå¤§æ¦‚ç‡æ˜¯ä¼˜è´¨/æ˜“è¯»æ€§å¼ºçš„é•¿æ–‡ï¼Œç›´æ¥æ”¾è¡Œï¼
                    shouldBlock = false;
                } else {
                    // æ²¡æœ‰é…å›¾ï¼Œä¸”è¢«æˆªæ–­äº†ï¼Œéœ€è¦å®¡åˆ¤å®ƒçš„æ‘˜è¦é•¿åº¦
                    // æ­¤æ—¶ pureTextLength ä»£è¡¨çš„æ˜¯â€œæ‘˜è¦æ˜¾ç¤ºçš„å­—æ•°â€
                    if (pureTextLength < SUMMARY_MIN_LENGTH) {
                        shouldBlock = true;
                        blockReason = `æ— å›¾ä¸”æ‘˜è¦è¿‡çŸ­ï¼Œä»…: ${pureTextLength} å­—`;
                    }
                }
            }

            // ================= æ‰§è¡Œ UI å±è”½ï¼ˆå°ç›¾ç‰Œï¼‰ =================
            if (shouldBlock) {
                const innerContent = card.querySelector('.RichContent-inner');

                if (innerContent) {
                    // éšè—åŸæ­£æ–‡
                    innerContent.style.display = 'none';

                    // éšè—å¯èƒ½æ¼ç½‘çš„å°é¢å›¾ï¼ˆè™½ç„¶æŒ‰ä¸Šé¢çš„é€»è¾‘èµ°åˆ°è¿™é‡Œå¤§æ¦‚ç‡æ²¡å›¾ï¼Œä½†æ±‚ç¨³ï¼‰
                    if (coverImage) coverImage.style.display = 'none';

                    // ä¼˜é›…çš„å°ç›¾ç‰Œå ä½æ¡
                    const noticeBox = document.createElement('div');
                    noticeBox.style.padding = '16px';
                    noticeBox.style.margin = '10px 0';
                    noticeBox.style.backgroundColor = '#f6f6f6';
                    noticeBox.style.color = '#8590a6';
                    noticeBox.style.borderRadius = '6px';
                    noticeBox.style.textAlign = 'center';
                    noticeBox.style.fontSize = '14px';
                    noticeBox.style.fontWeight = '500';
                    noticeBox.innerHTML = `ğŸ›¡ï¸ æ­¤å›ç­”å› ç¯‡å¹…è¿‡çŸ­å·²è¢«è¿‡æ»¤ (${blockReason})`;

                    innerContent.parentNode.insertBefore(noticeBox, innerContent);
                }
            }
        });
    }

    // é˜²æŠ–å‡½æ•°ï¼Œé˜²æ­¢é¡µé¢æ»šåŠ¨æ—¶é¢‘ç¹è§¦å‘è®¡ç®—å¯¼è‡´å¡é¡¿
    function debounce(func, wait) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func(...args), wait);
        };
    }

    const debouncedFilter = debounce(filterShortAnswers, 200);

    // é¡µé¢åˆšåŠ è½½æ—¶æ‰§è¡Œ
    filterShortAnswers();

    // ç›‘å¬é¡µé¢æ»šåŠ¨åŠ è½½ï¼ˆå¤„ç†ç€‘å¸ƒæµï¼‰
    const observer = new MutationObserver((mutations) => {
        let shouldProcess = false;
        mutations.forEach(mutation => {
            if (mutation.addedNodes.length > 0) {
                shouldProcess = true;
            }
        });
        if (shouldProcess) debouncedFilter();
    });

    observer.observe(document.body, { childList: true, subtree: true });

})();